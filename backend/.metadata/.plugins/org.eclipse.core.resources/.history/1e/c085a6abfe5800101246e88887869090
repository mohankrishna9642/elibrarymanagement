package com.elibrary.bookservice.controller;

import java.io.IOException;
import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.ContentDisposition; // NEW Import
import org.springframework.http.HttpHeaders; // NEW Import
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.elibrary.bookservice.dto.BookRequest;
import com.elibrary.bookservice.dto.BookResponse;
import com.elibrary.bookservice.service.BookService;

import jakarta.validation.Valid;

import org.slf4j.Logger; // NEW: Import Logger
import org.slf4j.LoggerFactory; // NEW: Import LoggerFactory

@RestController
@RequestMapping("/api/books")
public class BookController {

    private static final Logger controllerLogger = LoggerFactory.getLogger(BookController.class); // Logger instance

    private final BookService bookService;

    public BookController(BookService bookService) {
        this.bookService = bookService;
    }

    // ADMIN ONLY: Add new books
    @PostMapping(consumes = {MediaType.MULTIPART_FORM_DATA_VALUE})
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<BookResponse> addBook(
            @Valid @RequestPart("bookRequest") BookRequest bookRequest,
            @RequestPart("file") MultipartFile file) {
        controllerLogger.debug("BookController: Received request to add book: {} with file: {}", bookRequest.getTitle(), file.getOriginalFilename());
        try {
            BookResponse newBook = bookService.addBook(bookRequest, file);
            return new ResponseEntity<>(newBook, HttpStatus.CREATED);
        } catch (IOException e) {
            controllerLogger.error("BookController: Error adding book {}: {}", bookRequest.getTitle(), e.getMessage(), e);
            return new ResponseEntity<>(null, HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    // ADMIN ONLY: Modify existing books
    @PutMapping(value = "/{id}", consumes = {MediaType.MULTIPART_FORM_DATA_VALUE})
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<BookResponse> updateBook(
            @PathVariable Long id,
            @Valid @RequestPart("bookRequest") BookRequest bookRequest,
            @RequestPart(value = "file", required = false) MultipartFile file) {
        controllerLogger.debug("BookController: Received request to update book ID: {}", id);
        try {
            BookResponse updatedBook = bookService.updateBook(id, bookRequest, file);
            return ResponseEntity.ok(updatedBook);
        } catch (IOException e) {
            controllerLogger.error("BookController: Error updating book ID {}: {}", id, e.getMessage(), e);
            return new ResponseEntity<>(null, HttpStatus.INTERNAL_SERVER_ERROR);
        } catch (com.elibrary.bookservice.exception.ResourceNotFoundException e) {
            controllerLogger.error("BookController: Update failed, book not found with ID: {}", id);
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
    }

    // ADMIN ONLY: Delete books
    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<String> deleteBook(@PathVariable Long id) {
        controllerLogger.debug("BookController: Received request to delete book ID: {}", id);
        try {
            bookService.deleteBook(id);
            return ResponseEntity.ok("Book deleted successfully!");
        } catch (com.elibrary.bookservice.exception.ResourceNotFoundException e) {
            controllerLogger.error("BookController: Delete failed, book not found with ID: {}", id);
            return new ResponseEntity<>(e.getMessage(), HttpStatus.NOT_FOUND);
        }
    }

    // ADMIN ONLY: View all books for management
    @GetMapping("/admin/all")
    @PreAuthorize("hasRole('ADMIN')") // Changed from isAuthenticated() to hasRole('ADMIN') for admin list
    public ResponseEntity<Page<BookResponse>> getAllBooksForAdmin(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        controllerLogger.debug("BookController: Received request to get all books for admin view. Page: {}, Size: {}", page, size);
        Pageable pageable = PageRequest.of(page, size);
        Page<BookResponse> books = bookService.getAllBooks(pageable);
        return ResponseEntity.ok(books);
    }

    // PUBLIC ACCESS: Browse/Search books
    @GetMapping("/browse")
    @PreAuthorize("permitAll()")
    public ResponseEntity<List<BookResponse>> searchAndFilterBooks(
            @RequestParam(required = false) String query,
            @RequestParam(required = false) String genre,
            @RequestParam(required = false) String author,
            @RequestParam(defaultValue = "false") boolean popularity) {
        controllerLogger.debug("BookController: Received request to search/filter books. Query: {}, Genre: {}, Author: {}, Popularity: {}", query, genre, author, popularity);
        List<BookResponse> books = bookService.searchAndFilterBooks(query, genre, author, popularity);
        return ResponseEntity.ok(books);
    }

    // AUTHENTICATED USERS: View a single book's details
    @GetMapping("/{id}")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<BookResponse> getBookById(@PathVariable Long id) {
        controllerLogger.debug("BookController: Received request to get book by ID: {}", id);
        try {
            BookResponse book = bookService.getBookById(id);
            return ResponseEntity.ok(book);
        } catch (com.elibrary.bookservice.exception.ResourceNotFoundException e) {
            controllerLogger.error("BookController: Book not found with ID: {}", id);
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
    }

    // CRITICAL FIX: Endpoint to retrieve and serve the actual book file by its unique name
    // The path here MUST match the /books/ prefix stored in the database's filePath field
    // and configured in WebConfig.java's addResourceHandlers.
    @GetMapping("/books/{filename}") // e.g., http://localhost:8080/api/books/books/UUID_muruga.pdf
    @PreAuthorize("permitAll()") // Allows public access to read files, as configured in SecurityConfig.
    public ResponseEntity<byte[]> serveBookFile(@PathVariable String filename) {
        controllerLogger.debug("BookController: Received request to serve file: {}", filename);
        try {
            // Call the service method to retrieve the file bytes
            byte[] fileContent = bookService.retrieveBookFile("/books/" + filename); // Pass full path as stored in DB
            
            HttpHeaders headers = new HttpHeaders();
            
            // Determine content type dynamically based on file extension
            String contentType = "application/octet-stream"; // Default generic binary type
            if (filename.toLowerCase().endsWith(".pdf")) {
                contentType = MediaType.APPLICATION_PDF_